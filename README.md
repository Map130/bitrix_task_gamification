# Система геймификации задач для Bitrix24

Этот проект представляет собой микросервисную систему для сбора и отображения статистики по задачам из Bitrix24. Основная цель — геймификация, например, построение лидербордов на основе количества закрытых задач за неделю.

Ключевой особенностью системы является гибкая архитектура с централизованным управлением конфигурацией, позволяющая динамически переключать режим сбора данных без перезапуска сервисов.

## Архитектура

Система состоит из следующих микросервисов, работающих в Docker-контейнерах:

- **`config-server`**: **Центр управления конфигурацией.** Хранит настройки в PostgreSQL, кэширует их в Redis и уведомляет другие сервисы об изменениях через RabbitMQ. Предоставляет API для управления.

- **`producer`**: **Сборщик данных (режим опроса).** Периодически (раз в 5 минут) опрашивает API Bitrix24, собирает полный "снимок" всех закрытых за неделю задач и отправляет его в RabbitMQ. Активируется, только если в `config-server` установлен режим `polling`.

- **`producer-webhook`**: **Сборщик данных (режим вебхуков).** Принимает вебхуки от Bitrix24 при закрытии задачи, запрашивает детали этой одной задачи и отправляет "событие" в RabbitMQ. Активируется, только если в `config-server` установлен режим `webhook`.

- **`consumer`**: **Универсальный обработчик.** Слушает сообщения от обоих продюсеров. Умеет обрабатывать как полные "снимки" (полностью перезаписывая кэш), так и единичные "события" (атомарно добавляя данные в кэш).

- **`api`**: **Публичный API.** Предоставляет внешним клиентам (например, фронтенду) доступ к данным из кэша Redis (списки пользователей и задач).

- **`postgres`**: База данных для надежного хранения конфигураций.

- **`redis`**: Быстрое хранилище (кэш) для оперативных данных (задачи, пользователи) и кэширования конфигурации.

- **`rabbitmq`**: Брокер сообщений для асинхронного взаимодействия между сервисами.

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <your-repo-url>
    cd bitrix_task_gamification
    ```

2.  **Создайте и настройте `.env` файл:**
    Скопируйте файл с примером переменных окружения.
    ```bash
    cp .env-example .env
    ```
    Откройте файл `.env` и **обязательно** впишите ваш реальный URL вебхука в переменную `BITRIX_WEBHOOK_URL`.

3.  **Соберите и запустите контейнеры:**
    ```bash
    docker compose up --build -d
    ```
    Эта команда соберет образы всех сервисов и запустит их в фоновом режиме.

## Управление режимом сбора данных

Вы можете динамически переключать режим работы продюсеров через API `config-server`, который работает на порту `8090`.

#### Получение текущей конфигурации

```bash
curl http://localhost:8090/configs
```
Ответ будет выглядеть так:
```json
[
  {
    "key": "producer_mode",
    "value": "polling"
  }
]
```

#### Переключение на режим вебхуков

```bash
curl -X POST http://localhost:8090/configs 
-H "Content-Type: application/json" 
-d '{"key": "producer_mode", "value": "webhook"}'
```
После этого `producer` перейдет в режим ожидания, а `producer-webhook` начнет активно обрабатывать события.

#### Возврат в режим опроса

```bash
curl -X POST http://localhost:8090/configs 
-H "Content-Type: application/json" 
-d '{"key": "producer_mode", "value": "polling"}'
```
`producer-webhook` перестанет обрабатывать события, а `producer` возобновит свою работу.

## Описание сервисов и портов

- **API (`api`)**: `8080` – Основной API для получения данных.
- **Config Server (`config-server`)**: `8090` – API для управления конфигурацией.
- **Producer Webhook (`producer-webhook`)**: `8000` – Принимает вебхуки от Bitrix24.
- **RabbitMQ**: `5672` (протокол AMQP), `15672` (веб-интерфейс управления).
- **PostgreSQL**: `5432` – Порт базы данных.
- **Redis**: `6379` – Порт Redis.
