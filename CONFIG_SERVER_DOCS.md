# Документация по Config Server

## Обзор

`Config Server` — это централизованный сервис для управления конфигурацией всего приложения. Он решает следующие задачи:

1.  **Централизованное хранение**: Все конфигурационные параметры хранятся в базе данных PostgreSQL.
2.  **Кэширование**: Для быстрого доступа конфигурация кэшируется в Redis.
3.  **Уведомления**: При изменении конфигурации все остальные сервисы получают уведомление через RabbitMQ и автоматически обновляют свои настройки.
4.  **Безопасность**: Конфиденциальные данные (секреты), такие как API-ключи и токены, хранятся в зашифрованном виде.

## Как это работает

1.  При запуске `config-server` заполняет базу данных начальными значениями.
2.  Затем он загружает все данные из базы, расшифровывает секреты и сохраняет полную конфигурацию в Redis в виде единого JSON-объекта.
3.  Остальные сервисы (`api`, `producer`, `consumer` и т.д.) при старте запрашивают конфигурацию у `config-server` через его REST API.
4.  Если вы изменяете конфигурацию через API `config-server`, он обновляет запись в базе данных, обновляет кэш в Redis и отправляет сообщение в RabbitMQ.
5.  Сервисы, подписанные на обновления, получают сообщение, запрашивают свежую конфигурацию и применяют её "на лету".

## API Endpoints

Вы можете управлять конфигурацией, отправляя HTTP-запросы к `config-server`.

### 1. Получить всю конфигурацию

Этот эндпоинт используется всеми сервисами для получения актуальных настроек.

- **URL**: `http://localhost:8081/api/v1/configs/all`
- **Метод**: `GET`
- **Пример запроса с помощью `curl`**:
  ```bash
  curl -X GET http://localhost:8081/api/v1/configs/all
  ```
- **Пример ответа**:
  ```json
  {
    "BITRIX_WEBHOOK_URL": "your_bitrix_webhook_url_here",
    "RABBITMQ_QUEUE_TASKS": "tasks_queue",
    "RABBITMQ_QUEUE_RESULTS": "results_queue",
    "API_KEY": "your_api_key_here",
    "RABBITMQ_URL": "amqp://guest:guest@rabbitmq:5672/%2F",
    "REDIS_URL": "redis://redis:6379/0"
  }
  ```

### 2. Создать или обновить параметр конфигурации

Этот эндпоинт позволяет добавить новый параметр или изменить существующий.

- **URL**: `http://localhost:8081/api/v1/configs`
- **Метод**: `POST`
- **Тело запроса (JSON)**:
  - `key` (string, required): Имя параметра.
  - `value` (string, required): Значение параметра.
  - `is_secret` (boolean, optional, default: `false`): Установите `true`, если значение является секретом и должно храниться в зашифрованном виде.

- **Пример 1: Добавление нового простого параметра**
  ```bash
  curl -X POST http://localhost:8081/api/v1/configs \
  -H "Content-Type: application/json" \
  -d '{
    "key": "NEW_PARAMETER",
    "value": "some_value",
    "is_secret": false
  }'
  ```

- **Пример 2: Обновление секрета (например, API-ключа)**
  ```bash
  curl -X POST http://localhost:8081/api/v1/configs \
  -H "Content-Type: application/json" \
  -d '{
    "key": "API_KEY",
    "value": "new_super_secret_api_key",
    "is_secret": true
  }'
  ```

## Текущие параметры конфигурации

- `BITRIX_WEBHOOK_URL`: URL входящего вебхука для интеграции с Bitrix24. **(Секрет)**
- `RABBITMQ_QUEUE_TASKS`: Имя очереди RabbitMQ для новых задач.
- `RABBITMQ_QUEUE_RESULTS`: Имя очереди RabbitMQ для результатов выполнения задач.
- `API_KEY`: Ключ для авторизации запросов к `producer-webhook`. **(Секрет)**
- `RABBITMQ_URL`: URL для подключения к RabbitMQ.
- `REDIS_URL`: URL для подключения к Redis.

## Управление секретами

Когда вы отправляете параметр с флагом `"is_secret": true`, `config-server` делает следующее:
1.  Шифрует значение с помощью ключа `CONFIG_ENCRYPTION_KEY` из вашего `.env` файла.
2.  Сохраняет **зашифрованное** значение в базе данных PostgreSQL.
3.  При синхронизации с Redis значение расшифровывается и помещается в кэш в открытом виде для использования сервисами.

Это обеспечивает безопасность хранения секретов в постоянном хранилище (базе данных).
